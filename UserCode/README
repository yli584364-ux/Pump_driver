
项目：Pump_test — 泵与电磁阀驱动层说明
=====================================

简介
----
- 本目录包含基于 STM32F4 HAL 的泵 (PWM 控制) 与电磁阀（原 Sensor） 的 BSP 与驱动示例代码。
- 目标：把硬件相关（引脚、时钟、定时器）放在 BSP 层，驱动层封装功能接口供上层调用。

目录结构（相关文件）
-------------------
- `UserCode/bsp/bsp_pump.h`    : 板级引脚、定时器及宏定义（PWM 引脚/通道映射）。
- `UserCode/bsp/bsp_pump.c`    : BSP 初始化（GPIO、定时器 PWM 初始化、使能时钟）。
- `UserCode/driver/pump_ctrl.h`: 驱动接口声明（泵、阀门控制 API）。
- `UserCode/driver/pump_ctrl.c`: 驱动实现（调用 BSP 暴露的句柄/宏控制 PWM 与 GPIO）。

构建与运行
-----------
- 推荐通过 VS Code 提供的 Tasks 构建：菜单 Terminal -> Run Task... -> 选择 `build`。
- 或在 PowerShell 中（在工程根目录）运行：

```powershell
unify_builder -p e:\WTR\sucker\Pump_test\build\Debug\builder.params
```

如果需要清理再构建，使用 workspace 中的 `clean` / `rebuild` 任务。

BSP 与 PWM 说明
----------------
- PWM 输出引脚定义位置：`UserCode/bsp/bsp_pump.h`，宏例：
	- `BSP_PUMP_GPIO_PORT` / `BSP_PUMP_GPIO_PIN` — PWM 输出对应的 GPIO。
	- `BSP_PUMP_TIM` / `BSP_PUMP_TIM_CHANNEL` — 使用的 `TIM_HandleTypeDef` 实例与通道（例如 `htim4`、`TIM_CHANNEL_1`）。
- BSP 初始化位置：`UserCode/bsp/bsp_pump.c` 的 `BSP_Pump_Init()`，负责：
	- 使能对应 GPIO 与 TIM 的 RCC 时钟（`__HAL_RCC_GPIOx_CLK_ENABLE()`，`__HAL_RCC_TIMx_CLK_ENABLE()`）。
	- 配置 GPIO 为 AF（复用）模式并设置 `Alternate` 为对应 TIM 的 AF（例如 `GPIO_AF2_TIM4`）。
	- 初始化并启动 PWM：`HAL_TIM_PWM_Init()`、`HAL_TIM_PWM_ConfigChannel()`、`HAL_TIM_PWM_Start()`。

注意事项：
- 当前示例中 `BSP_PUMP_GPIO_PIN` 初始设置为 `PA0`，但 TIM4_CH1 常见复用引脚为 `PB6`（或其他，视芯片封装与数据手册而定）。请以实际硬件手册为准并同时修改 `bsp_pump.c` 的 GPIO 时钟与 `Alternate` 设置。
- 如果使用 CubeMX/HAL 的 MSP 回调（`HAL_TIM_PWM_MspInit`），也可以把时钟与 GPIO 配置放入 MSP 文件，BSP 层调用 `HAL_TIM_PWM_Init` 时会自动回调。

驱动 API 快速参考
-------------------
- BSP 层（板级）
	- `void BSP_Pump_GPIO_Init(void);` — 初始化泵与阀门的普通 GPIO（输出）。
	- `void BSP_Pump_Init(void);` — 初始化并启动泵的 PWM（计时器、通道、GPIO AF）。

- 驱动层（面向业务）
	- `void PumpCtrl_Init(void);` — 驱动层初始化（会调用 BSP 初始化）。
	- `void Pump_On(void);` / `void Pump_Off(void);` — 直接控制泵电源引脚。
	- `void Pump_SetPower(uint8_t power);` — 设置占空比（0-100）。
	- `void Valve_On(void);` / `void Valve_Off(void);` — 电磁阀控制（原 Sensor 接口已重命名为 Valve，示例中保留向后兼容宏）。

如何修改 PWM 引脚（步骤）
------------------------
1. 在 `bsp_pump.h` 中设置目标 GPIO 口与引脚（例如 `GPIOB` / `GPIO_PIN_6`）。
2. 在 `bsp_pump.c` 中使能对应 GPIO 时钟（`__HAL_RCC_GPIOB_CLK_ENABLE()`），并在 `GPIO_InitTypeDef` 中设置 `Alternate` 为对应 AF（例如 `GPIO_AF2_TIM4`）。
3. 确认 `BSP_PUMP_TIM.Instance` 与 `BSP_PUMP_TIM_CHANNEL` 与所选引脚的 TIMx_CHy 映射一致。
4. 重新编译并在示波器上验证 PWM 波形频率与占空比。

常见问题与排查
----------------
- 编译报找不到 HAL 头文件：确认项目使用的是 STM32F4 HAL，并在项目 include 路径中包含 `Drivers/STM32F4xx_HAL_Driver/Inc` 与 `Drivers/CMSIS/Device/ST/STM32F4xx/Include`。
- PWM 无输出：检查是否设置了 GPIO 的 `Alternate` 字段并启用了正确的 GPIO 时钟；确认 `HAL_TIM_PWM_Start` 返回成功。
- 占空比异常：检查 `Pulse` 值是否在 `[0, Period]` 范围内；若修改 Prescaler/Period 后请重新计算占空比与频率。

使用建议->对于佑诚VN-C4气泵2026WTR
- 全功率运转时，气泵供电24V,实测气压-72Kpa左右，对于卷轴可能过大，建议使用PWM调节占空比运行。
- 50%占空比时，气压约-50Kpa。
- （上述气压均为吸引卷轴时的实测值，具体数值可能因环境和设备差异有所不同）